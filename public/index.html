<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Terminal</title>
  <link rel="stylesheet" href="https://unpkg.com/xterm/css/xterm.css" />
  <style>
    body,
    html {
      height: 100%;
      width: 100%;
      margin: 0;
      display: flex;
      background-color: #000;
    }

    #terminal {
      flex: 1;
      display: flex;
    }

    .xterm {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
  </style>
</head>

<body>
  <div id="terminal"></div>
  <script src="https://unpkg.com/socket.io/client-dist/socket.io.js"></script>
  <script src="https://unpkg.com/xterm/lib/xterm.js"></script>
  <script src="https://unpkg.com/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
  <script>
    ; (async () => {
      function fmtUrl(route, uri = "https") {
        return `${uri}://${window.location.host}/${route.startsWith("/") ? route.substring(0, 1) : route}`
      }

      const man = new io.Manager(fmtUrl("", "wss"))
      let socket = man.socket("/term", { autoConnect: false })
      const terminal = new Terminal();
      const fitAddon = new FitAddon.FitAddon();
      terminal.loadAddon(fitAddon);
      terminal.open(document.getElementById('terminal'));

      const resizeTerminal = () => {
        fitAddon.fit();
        socket.emit('resize', { cols: terminal.cols, rows: terminal.rows });
      };

      // Initial fit
      resizeTerminal();
      window.addEventListener('resize', resizeTerminal);


      await new Promise(async res => {
        terminal.writeln("-----")
        terminal.writeln("Hello there! This site hosts a simple terminal instance available to anyone")
        terminal.writeln("with an Internet connection. To restore to a clean state and prevent malicious")
        terminal.writeln("use, this Linux instance resets every 6 hours.")

        const uptime = await fetch(fmtUrl("/uptime"))
        terminal.writeln(`[uptime: ${uptime.uptime}, restarts in: ${uptime.timeTillRestart}]`)

        terminal.writeln("")
        terminal.writeln("By hitting ENTER and connecting to the server, you have read the above and agree")
        terminal.writeln("not to abuse any functionality, and to use the server in a lawful manner.")
        terminal.writeln("-----")

        let dispose
        const cb = key => {
          if (key.charCodeAt(0) == 13) {
            terminal.writeln("[INFO] agreed to agreement; connecting...")
            dispose()
            res()
          }
        }
        dispose = terminal.onData(cb).dispose
      })

      socket.connect();

      socket.on('output', (data) => {
        terminal.write(data);
      });

      terminal.onData(data => {
        socket.emit('input', data);
      });

      socket.on("disconnect", () => {
        terminal.writeln("\n[ERROR] connection lost; reconnecting...")
      })

      socket.on("reconnect", () => {
        terminal.writeln("\n[INFO] successfully reconnected!")
      })
    })()
  </script>
</body>

</html>