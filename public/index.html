<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Open Terminal</title>
  <link rel="stylesheet" href="https://unpkg.com/xterm/css/xterm.css" />
  <style>
    body,
    html {
      height: 100%;
      width: 100%;
      margin: 0;
      display: flex;
      background-color: #000;
    }

    #terminal {
      flex: 1;
      display: flex;
    }

    .xterm {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
    }
  </style>
</head>

<body>
  <div id="terminal"></div>
  <script src="https://unpkg.com/socket.io/client-dist/socket.io.js"></script>
  <script src="https://unpkg.com/xterm/lib/xterm.js"></script>
  <script src="https://unpkg.com/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
  <script src="https://unpkg.com/@xterm/addon-clipboard"></script>
  <script>
    ; (async () => {
      function fmtUrl(route, uri = "https") {
        return `${uri}://${window.location.host}/${route.startsWith("/") ? route.substring(1) : route}`
      }

      const man = new io.Manager(fmtUrl("", "wss"), { autoConnect: false })
      let socket = man.socket("/term")
      const terminal = new Terminal();

      const fitAddon = new FitAddon.FitAddon();
      terminal.loadAddon(fitAddon);

      const clipboardAddon = new ClipboardAddon.ClipboardAddon();
      terminal.loadAddon(clipboardAddon)

      terminal.open(document.getElementById('terminal'));

      const resizeTerminal = () => {
        fitAddon.fit();
        socket.emit('resize', { cols: terminal.cols, rows: terminal.rows });
      };

      // Initial fit
      resizeTerminal();
      window.addEventListener('resize', resizeTerminal);


      await new Promise(async res => {
        terminal.writeln("-----")
        terminal.writeln("Hello there! This site hosts a simple terminal instance available to anyone")
        terminal.writeln("with an Internet connection. To restore to a clean state and prevent malicious")
        terminal.writeln("use, this Linux instance resets every 6 hours.")

        const uptime = await (await fetch(fmtUrl("/uptime"))).json()
        terminal.writeln(`\n[uptime: ${uptime.uptime}, restarts in: ${uptime.timeTillRestart}]`)

        terminal.writeln("-----")
        terminal.writeln("By hitting ENTER and connecting to the server, you have read the above and agree")
        terminal.writeln("not to abuse any functionality, and to use the server in a lawful manner.")
        terminal.writeln("Misuse/abuse and participation in illegal activity is prohibited.")
        terminal.writeln("-----")

        let dispose
        const cb = key => {
          if (key.charCodeAt(0) == 13) {
            terminal.writeln("[INFO] agreed to agreement; connecting...")
            dispose()
            res()
          }
        }
        dispose = terminal.onData(cb).dispose
      })

      socket.connect();

      socket.on('output', (data) => {
        terminal.write(data);
      });

      terminal.onData(data => {
        socket.emit('input', data);
      });

      terminal.onBell(() => {
        // play bell chime
      })

      // Handle mouse events
      terminal.element.addEventListener('mousedown', (event) => {
        handleMouseEvent(event, 'mousedown');
      });

      terminal.element.addEventListener('mouseup', (event) => {
        handleMouseEvent(event, 'mouseup');
      });

      terminal.element.addEventListener('mousemove', (event) => {
        handleMouseEvent(event, 'mousemove');
      });

      function handleMouseEvent(event, type) {
        const { clientX, clientY } = event; // Get mouse coordinates relative to the viewport
  const rect = terminal.element.getBoundingClientRect();
  const x = clientX - rect.left; // Calculate mouse x position relative to terminal
  const y = clientY - rect.top;  // Calculate mouse y position relative to terminal

  // Emitting data via socket in the format expected by the backend
  socket.emit('mouse', { x, y, type });
      }

      socket.on("disconnect", () => {
        terminal.writeln("\n[ERROR] connection lost; reconnecting...")
        resizeTerminal()
      })
    })()
  </script>
</body>

</html>